---
title: 8ビットパソコンを作る (3)
author: Kazumasa
layout: post
tags: [Z80, AKI-80, バックプレーン, backplane, バンク切り替え, bank switching]
description: Building a PC with Z80
---

今日はバックプレーン基板に載せるコネクタ選択回路、バンク切り替え回路の検討結果をまとめる。

コネクタ選択回路、バンク切り替え回路は標準ロジックICで作成する。

I/Oアドレスのデコードには74138(3 to 8 Decoder)を使用する。74138は3ビットのアドレス、つまり0〜7の数値を受け取り、その値に対応した出力信号線をLレベルにする。74138は3ビットのアドレス入力の他に3つの制御信号入力を持っており、合計6本の入力端子を持っている。Z80のI/Oアドレスは8ビット(本当は16ビット使える)なので、I/Oアドレスの上位6ビット(A7..A2)を74138へ入力し、下位の2ビット(A1, A0)は無視することにする。つまり、バンク切り替え回路のI/Oアドレスを0x20とすると、実際は0x21〜23もバンク切り替え回路のI/Oアドレスとして使うことができる。

74138の6本の入力端子のうち3本がデコード対象の信号となり、残りの3本が制御用の信号である。デコード対象となるビット列をA4..A2、制御用のビット列をA7..A5とする。I/Oアドレスに0x20以降、0b00100000を割り当ててあるが、デコード対象のビットをa、無視するビットをxで表すと、0b001aaaxxとなる。つまり制御用のビットは0b001なのでこれらが入力されたときにデコード回路が動作するように制御端子へ接続する必要がある。74138の場合はE3にA5、E1、E2にA6、A7を繋げばよい。

![I/Oデコード回路](/assets/images/decode1.png)

コネクタ選択回路用の出力には、74138の出力をそのまま使用するため3本の出力信号が必要になる。一方でバンク切り替え回路用の出力は、ページ番号を保持するためのフリップフロップの制御用の1本で良い。用途をはっきり区別するためにI/Oアドレスは0x20をバンク切り替え用、0x30、0x34、0x38、0x3Cをコネクタ選択用とする。

| I/O アドレス | 内部回路 | 機能               |
|--------------|----------|--------------------|
|         0x20 | PAGESEL  | SRAMページ切り替え |
|         0x30 | IOSEL0   | 拡張コネクタ0選択  |
|         0x34 | IOSEL1   | 拡張コネクタ1選択  |
|         0x38 | IOSEL2   | 拡張コネクタ2選択  |
|         0x3C | IOSEL3   | 拡張コネクタ3選択  |

ページ番号を保持するためには74175を使用する。74175には4つのフリップフロップが内蔵されている。フリップフロップの入力にデータバスの下位4ビット(D0〜D3)を接続し、前段のデコーダの出力とZ80のI/O書き込み信号が両方共にHになったタイミングで値を保持する。

![アドレスラッチ](/assets/images/latch.png)

ページ番号のうち下位の2桁はそのままSRAMへ供給する。つまりSRAMのA16、A17へ接続する。一方、上位2桁は74238(3 to 8 Decoder)を使ってデコードし、SRAMチップのイネーブル端子へ接続する。I/Oアドレスのデコードには74138を使用したが、74238と74138の違いは出力が正論理か負論理かの違いである。拡張コネクタに接続する1MビットSRAM(68127)にはイネーブル端子が2つあり、一つは正論理、一つは負論理である。このSRAMはZ80のアドレス空間の下位32KiBに配置するため、アクセス時のアドレス信号の最上位ビット(A15)は必ず0になっている。そこでA15を負論理側のイネーブル端子に接続するのが都合が良い。その結果、デコーダ回路の出力は正論理のイネーブル端子に接続できる方が良いので、74238を使用している。

![アドレスデコード回路](/assets/images/decode2.png)
